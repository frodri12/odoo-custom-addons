<?xml version="1.0" encoding="utf-8"?>

<odoo>

    <!-- Workaround for Studio reports, see odoo/odoo#60660 -->
    <template id="report_invoice" inherit_id="account.report_invoice">
        <xpath expr='//t[@t-call="account.report_invoice_document"]' position="after">
            <t t-elif="o._get_name_invoice_report() == 'l10n_py_account.report_invoice_document'">
                <t t-call="l10n_py_account.report_invoice_document" t-lang="lang">
                    <t t-set="subtotal_exempt_custom" t-value="0" />
                    <t t-set="subtotal_tax5_custom" t-value="0" />
                    <t t-set="subtotal_tax10_custom" t-value="0" />
                </t>
            </t>
        </xpath>
    </template>

    <!-- report_invoice_document -->
    <template id="report_invoice_document" inherit_id="account.report_invoice_document"
        primary="True">

        <t t-set="o" position="after">
            <t t-set="custom_header" t-value="'l10n_py_account.custom_header'" />
            <t t-set="report_date" t-value="o.invoice_date" />
            <t t-set="report_number" t-value="o.l10n_latam_document_number" />
            <t t-set="pre_printed_report" t-value="report_type == 'pdf'" />
            <t t-set="document_letter" t-value="A" />
            <t t-set="document_legend" t-value="o.l10n_latam_document_type_id.code and 'Cod. %02d' % int(o.l10n_latam_document_type_id.code) or ''" />
            <t t-set="report_name" t-value="o.display_report_name()" />
            <t t-set="header_address" t-value="o.company_id.partner_id" />
            <t t-set="subtotal_exempt_custom" t-value="0" />
            <t t-set="subtotal_tax5_custom" t-value="0" />
            <t t-set="subtotal_tax10_custom" t-value="0" />
            <t t-set="custom_footer">
                <div class="row">
                    <div name="footer_left_column" class="col-8 text-start">
                    </div>
                    <div name="footer_right_column" class="col-4 text-end">
                        <div name="pager" t-if="report_type == 'pdf'"> Page: <span class="page" /> / <span class="topage" />
                        </div>
                    </div>
                </div>
            </t>
        </t>

        <!-- remove default partner address -->
        <t t-set="address" position="replace" />
        <xpath expr="//div[@name='address_not_same_as_shipping']" position="replace">
            <div name="address_not_same_as_shipping" />
        </xpath>
        <xpath expr="//div[@name='address_same_as_shipping']" position="replace">
            <div name="address_same_as_shipping" />
        </xpath>
        <xpath expr="//div[@name='no_shipping']" position="replace">
            <div name="no_shipping" />
        </xpath>
        <!-- remove default document title -->
        <xpath expr="//t[@t-set='layout_document_title']" position="replace" />

        <xpath expr="//div[hasclass('invoice_main')]" position="attributes">
            <attribute name="style" add="height:800px" separator=";" />
        </xpath>
        <!-- -->
        <xpath expr="//div[@id='informations']" position="replace">
            <div id="informations" class="row mb-4">
                <div class="col-6" style="padding-left:1rem;">
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Fecha de Emisión: </strong>
                            <strong style="font-size:0.7rem" t-field="o.invoice_date" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Condición de Venta: </strong>
                            <t t-if="o.l10n_py_dnit_pay == 1">
                                <strong style="font-size:0.7rem">CONTADO</strong>
                            </t>
                            <t t-else="">
                                <strong style="font-size:0.7rem">CREDITO</strong>
                            </t>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Cuotas: </strong>
                            <t t-if="o.l10n_py_dnit_pay != 1"><strong style="font-size:0.7rem" t-out="1" /></t>
                        </div>
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Plazo del crédito: </strong>
                            <t t-if="o.l10n_py_dnit_pay != 1"><strong style="font-size:0.7rem" t-field="o.l10n_py_dnit_pay_plazo"/></t>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Moneda: </strong>
                            <strong style="font-size:0.7rem" t-field="o.currency_id.full_name" />
                        </div>
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Tipo de Cambio: </strong>
                            <t t-if="o.currency_id != o.company_currency_id"><strong style="font-size:0.7rem" t-out="1/o.invoice_currency_rate" /></t>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Tipo de cambio global o por Item:: GLOBAL</strong>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">RUC/Documento de Identidad: </strong>
                            <strong style="font-size:0.7rem" t-field="o.partner_id.vat" />
                        </div>

                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Razón Social:</strong>
                            <strong style="font-size:0.7rem" t-field="o.partner_id.name" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Address:</strong>
                            <strong style="font-size:0.7rem" t-field="o.partner_id.contact_address_complete" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Teléfono:</strong>
                            <strong style="font-size:0.7rem" t-field="o.partner_id.phone" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Correo electrónico:</strong>
                            <strong style="font-size:0.7rem" t-field="o.partner_id.email" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <strong t-att-style="'font-size:0.7rem;color: %s;' % o.company_id.secondary_color">Tipo de Transacción:</strong>
                            <strong style="font-size:0.7rem" t-field="o.l10n_py_dnit_concept" />
                        </div>
                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//table[@name='invoice_line_table']" position="attributes">
            <attribute name="style" add="font-size:0.7rem" separator=";" />
        </xpath>
        <!-- THs de la tabla de detalle -->
        <xpath expr="//th[@name='th_description']" position="before">
            <th name="th_code_custom" class="text-start">
                <span>Code</span>
            </th>
        </xpath>

        <xpath expr="//th[@name='th_taxes']" position="replace" />

        <xpath expr="//th[@name='th_subtotal']" position="replace">
            <th name="th_subtotal_exempt_custom" class="text-end">
                <span>Exempt</span>
            </th>
            <th name="th_subtotal_tax5_custom" class="text-end">
                <span>Taxed 5%</span>
            </th>
            <th name="th_subtotal_tax10_custom" class="text-end">
                <span>Taxed 10%</span>
            </th>
        </xpath>

        <!-- TDs de la tabla de detalle -->
        <xpath expr="//td[@name='account_invoice_line_name']" position="replace">
            <td name="td_code_custom" class="text-start">
                <t t-set="code_custom" t-value="line.product_id.default_code if line.product_id.default_code else line.product_id.id" />
                <span t-if="code_custom" t-out="code_custom" t-options="{'widget': 'text'}">Cod</span>
            </td>
            <td name="account_invoice_line_name">
                <t t-if="line.product_id.name">
                    <span t-field="line.product_id.name" t-options="{'widget': 'text'}">Bacon Burger</span>
                </t>
                <t t-else="">
                    <span t-field="line.name" t-options="{'widget': 'text'}">Bacon Burger</span>
                </t>
            </td>
        </xpath>

        <xpath expr="//td[@name='td_quantity']" position="replace">
            <td name="td_quantity" class="text-end text-nowrap">
                <span t-field="line.quantity">3.00</span>
                <span t-field="line.product_uom_id.name">units</span>
            </td>
        </xpath>

        <xpath expr="//td[@name='td_price_unit']" position="replace">
            <td name="td_price_unit" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span class="text-nowrap" t-field="line.price_unit" t-options='{"widget": "monetary", "display_currency": o.currency_id}'>9.00</span>
            </td>
        </xpath>

        <xpath expr="//td[@name='td_taxes']" position="replace" />

        <xpath expr="//td[@name='td_subtotal']" position="replace">
            <t t-set="subtotal_exempt_custom" t-value="subtotal_exempt_custom + line.l10n_py_base_grav_exe" />
            <t t-set="subtotal_tax5_custom" t-value="subtotal_tax5_custom + line.l10n_py_base_grav_tax5" />
            <t t-set="subtotal_tax10_custom" t-value="subtotal_tax10_custom + line.l10n_py_base_grav_tax10" />
            <td name="td_subtotal_exempt_custom" class="text-end o_price_total">
                <span class="text-nowrap" t-field="line.l10n_py_base_grav_exe" t-options='{"widget": "monetary", "display_currency": o.currency_id}'>27.00</span>
            </td>
            <td name="td_subtotal_tax5_custom" class="text-end o_price_total">
                <span class="text-nowrap" t-field="line.l10n_py_base_grav_tax5" t-options='{"widget": "monetary", "display_currency": o.currency_id}'>27.00</span>
            </td>
            <td name="td_subtotal_tax10_custom" class="text-end o_price_total">
                <span class="text-nowrap" t-field="line.l10n_py_base_grav_tax10" t-options='{"widget": "monetary", "display_currency": o.currency_id}'>27.00</span>
            </td>
        </xpath>

        <!-- Subtotales entre las lineas del producto -->
        <xpath expr="//t/tr[hasclass('is-subtotal')]" position="replace" />

        <!-- Linea de subtotales al final del detalle de la tabla -->
        <xpath expr="//table[hasclass('o_has_total_table')]/tbody" position="inside">
            <tr>
                <t t-if="display_discount">
                    <td colspan="5">
                        <strong>SUBTOTAL</strong>
                    </td>
                </t>
                <t t-else="">
                    <td colspan="4">
                        <strong>SUBTOTAL</strong>
                    </td>
                </t>
                <td class="text-end o_price_total">
                    <strong t-out="subtotal_exempt_custom" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
                <td class="text-end o_price_total">
                    <strong t-out="subtotal_tax5_custom" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
                <td class="text-end o_price_total">
                    <strong t-out="subtotal_tax10_custom" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
            </tr>
            <t t-if="o.tax_totals.get('display_in_company_currency')">
                <tr>
                    <t t-if="display_discount">
                        <td colspan="5">
                            <strong>SUBTOTAL IN GUARANIES</strong>
                        </td>
                    </t>
                    <t t-else="">
                        <td colspan="4">
                            <strong>SUBTOTAL IN GUARANIES</strong>
                        </td>
                    </t>
                    <td class="text-end o_price_total">
                        <strong t-out="subtotal_exempt_custom / o.invoice_currency_rate" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                    <td class="text-end o_price_total">
                        <strong t-out="subtotal_tax5_custom / o.invoice_currency_rate" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                    <td class="text-end o_price_total">
                        <strong t-out="subtotal_tax10_custom / o.invoice_currency_rate" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                </tr>
            </t>
        </xpath>

        <!-- Linea del subtotal -->
        <xpath expr="//div[@id='total']" position="replace"></xpath>

        <!-- Recuadro de los totales de IVA -->
        <xpath expr="//table[hasclass('o_has_total_table')]/tbody" position="inside"></xpath>

        <!-- Linea con el monto expresado en palabras-->
        <xpath expr="//p[hasclass('lh-sm')]" position="replace"></xpath>

        <!-- Recuadro del IVA con la moneda local-->
        <xpath expr="//t[@t-call='account.document_tax_totals_company_currency_template']" position="replace">
            <div class="oe_structure" />
        </xpath>
        <!-- Condiciones de pago-->
        <xpath expr="//div[@id='payment_term']" position="replace"></xpath>

        <!-- Agregado de valores de IVA -->
        <!--
        <xpath expr="//div[@id='right-elements']" position="before">
            <t t-call="l10n_py_account.kude_subtotal_taxes" t-lang="lang"></t>
        </xpath>
        -->
        <xpath expr="//div[hasclass('invoice_main')]" position="after">
            <xpath expr="//div[@id='right-elements']" position="before">
                <t t-call="l10n_py_account.kude_subtotal_taxes" t-lang="lang"></t>
            </xpath>
        </xpath>

    </template>

    <template id="kude_subtotal_taxes">
        <t t-set="tax_amount_5" t-value="0" />
        <t t-set="tax_amount_currency_5" t-value="0" />
        <t t-set="tax_amount_10" t-value="0" />
        <t t-set="tax_amount_currency_10" t-value="0" />
        <t t-set="tax_amount_total" t-value="0" />
        <t t-set="tax_amount_currency_total" t-value="0" />
        <t t-set="tax_totals" t-value="o.tax_totals" />

        <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
            <t t-set="tax_amount_total" t-value="subtotal['tax_amount']" />
            <t t-set="tax_amount_currency_total" t-value="subtotal['tax_amount_currency']" />
            <t t-foreach="subtotal['tax_groups']" t-as="tax_group">
                <t t-if="'5' in tax_group['group_name']">
                    <t t-set="tax_amount_5" t-value="tax_amount_5 + tax_group['tax_amount']" />
                    <t t-set="tax_amount_currency_5" t-value="tax_amount_currency_5 + tax_group['tax_amount_currency']" />
                </t>
                <t t-if="'10' in tax_group['group_name']">
                    <t t-set="tax_amount_10" t-value="tax_amount_10 + tax_group['tax_amount']" />
                    <t t-set="tax_amount_currency_10" t-value="tax_amount_currency_10 + tax_group['tax_amount_currency']" />
                </t>
            </t>
        </t>
        <table class="table table-borderless" style="font-size:0.7rem">
            <tr>
                <td class="text-start" colspan="5">
                    <strong>TOTAL OPERATION:</strong>
                </td>
                <td class="text-end o_price_total" colspan="2">
                    <h4>
                        <strong t-out="tax_totals['total_amount_currency']" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                    </h4>
                </td>
            </tr>

            <t t-if="o.company_id.display_invoice_amount_total_words">
                <tr>
                    <td class="text-start">
                        <span>Total to pay: </span>
                    </td>
                    <td class="text-end" colspan="6">
                        <span class="text-muted lh-sm" t-field="o.amount_total_words" />
                    </td>
                </tr>
            </t>

            <tr>
                <td class="text-start">
                    <strong>VAT SETTLEMENT:</strong>
                </td>
                <td class="text-end">
                    <strong>(5%):</strong>
                </td>
                <td class="text-end o_price_total">
                    <strong t-out="tax_amount_currency_5" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
                <td class="text-end">
                    <strong>(10%):</strong>
                </td>
                <td class="text-end o_price_total">
                    <strong t-out="tax_amount_currency_10" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
                <td class="text-end">
                    <strong>TOTAL:</strong>
                </td>
                <td class="text-end o_price_total">
                    <strong t-out="tax_amount_currency_total" t-options='{"widget": "monetary", "display_currency": o.currency_id}' />
                </td>
            </tr>
            <t t-if="o.tax_totals.get('display_in_company_currency')">
                <tr>
                    <td class="text-start">
                        <strong>VAT SETTLEMENT in Guaranies:</strong>
                    </td>
                    <td class="text-end">
                        <strong>(5%):</strong>
                    </td>
                    <td class="text-end o_price_total">
                        <strong t-out="tax_amount_5" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                    <td class="text-end">
                        <strong>(10%):</strong>
                    </td>
                    <td class="text-end o_price_total">
                        <strong t-out="tax_amount_10" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                    <td class="text-end">
                        <strong>TOTAL:</strong>
                    </td>
                    <td class="text-end o_price_total">
                        <strong t-out="tax_amount_total" t-options='{"widget": "monetary", "display_currency": o.company_currency_id}' />
                    </td>
                </tr>
            </t>
        </table>

    </template>


    <template id="custom_header">
        <div class="mb-3">
            <div class="row">
                <div name="left-upper-side" class="col-5">
                    <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 45px;" alt="Logo" />
                </div>
                <div name="center-upper" class="col-2 text-center" t-att-style="'color: %s;' % o.company_id.primary_color">
                    <span style="display: inline-block; text-align: center; line-height: 8px;"> </span>
                </div>
                <div name="right-upper-side" class="col-5 text-end" style="padding-left: 0px;">
                    <!-- (6) Titulo de Documento -->
                    <h4 t-att-style="'color: %s;' % o.company_id.primary_color">
                        <strong>
                            <span t-out="report_name" />
                        </strong>
                    </h4>
                </div>
            </div>
            <div class="row">
                <div class="col-6" style="padding-right: 0px;">
                    <!-- (1) Nombre de Fantasia -->
                    <!-- (2) Apellido y Nombre o Razon Social -->
                    <span t-field="o.company_id.partner_id.name" />

                    <!-- (3) Domicilio Comercial (Domicilio Fiscal is the same) -->
                    <br />
                    <div></div>
                    <!-- we dont use the address widget as it adds a new line on the phone and
                        we want to reduce at maximum lines qty -->
                    <t t-out="' - '.join([item for item in [
                            ', '.join([item for item in [header_address.street, header_address.street2] if item]),
                            header_address.city,
                            header_address.state_id and header_address.state_id.name,
                            header_address.zip,
                            header_address.country_id and header_address.country_id.name] if item])" />
                    <span t-if="header_address.phone"> - </span>
                    <span t-if="header_address.phone" style="white-space: nowrap;" t-out="'Tel: ' + header_address.phone" />
                    <br />
                    <span t-att-style="'color: %s;' % o.company_id.primary_color" t-out="' - '.join([item for item in [(header_address.website or '').replace('https://', '').replace('http://', ''), header_address.email] if item])" />

                </div>
                <div class="col-6 text-end" style="padding-left: 0px;">

                    <!-- (7) Numero punto venta - (8) numero de documento -->
                    <strong t-out="report_number" />
                    <br />

                    <!-- (9) Fecha -->
                    <span t-att-style="'color: %s;' % o.company_id.secondary_color">Date: </span>
                    <span t-out="report_date" t-options='{"widget": "date"}' />

                    <!-- (5) Condicion de IVA / Responsabilidad -->
                    <!-- (10) CUIT -->
                    <br />
                    <!-- <span t-field="o.company_id.l10n_ar_afip_responsibility_type_id" /> -->
                    <span t-att-style="'color: %s;' % o.company_id.secondary_color">RUC: </span>
                    <span t-field="o.company_id.partner_id.vat" />

                    <!-- (11) IIBB: -->
                    <!-- (12) Inicio de actividades -->
                    <br />
                    <span t-att-style="'color: %s;' % o.company_id.secondary_color">Timbrado: </span>
                    <t t-if="o.company_id.l10n_py_dnit_ws_environment == 'testing'">
                        <span t-field="o.journal_id.l10n_py_dnit_timbrado_test" />
                        <br />
                        <span t-att-style="'color: %s;' % o.company_id.secondary_color">Activities Start: </span>
                        <span t-field="o.journal_id.l10n_py_dnit_timbrado_start_date_test" />
                    </t>
                    <t t-else="o.company_id.l10n_py_dnit_ws_environment == 'testing'">
                        <span t-field="o.journal_id.l10n_py_dnit_timbrado" />
                        <br />
                        <span t-att-style="'color: %s;' % o.company_id.secondary_color">Activities Start: </span>
                        <span t-field="o.journal_id.l10n_py_dnit_timbrado_start_date" />
                    </t>
                </div>
            </div>
        </div>
    </template>

</odoo>